# æ¶æ„æ”¹è¿›å»ºè®®

> åŸºäºä»£ç å…¨é¢å®¡æŸ¥çš„è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

**ç‰ˆæœ¬**: 2.0 | **æ›´æ–°**: 2024-01 | **ç±»å‹**: æ”¹è¿›å»ºè®®

---

## ğŸ“‘ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¼˜å…ˆçº§çŸ©é˜µ](#ä¼˜å…ˆçº§çŸ©é˜µ)
- [é«˜ä¼˜å…ˆçº§ä¼˜åŒ–](#é«˜ä¼˜å…ˆçº§ä¼˜åŒ–)
- [ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–](#ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–)
- [ä½ä¼˜å…ˆçº§ä¼˜åŒ–](#ä½ä¼˜å…ˆçº§ä¼˜åŒ–)
- [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
- [é¢„æœŸæ”¶ç›Š](#é¢„æœŸæ”¶ç›Š)
- [å¿«é€Ÿå‚è€ƒ](#å¿«é€Ÿå‚è€ƒ)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå½“å‰ä»£ç åº“çš„å…¨é¢å®¡æŸ¥ï¼Œæå‡ºä¸€ç³»åˆ—æ¶æ„ä¼˜åŒ–å»ºè®®ã€‚è¿™äº›å»ºè®®æ—¨åœ¨è¿›ä¸€æ­¥æå‡ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œç³»ç»Ÿçš„å¥å£®æ€§ã€‚

### ä¼˜åŒ–ç›®æ ‡

- ğŸ¯ æå‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
- ğŸ¯ å¢å¼ºç³»ç»Ÿå¥å£®æ€§å’Œå¯é æ€§
- ğŸ¯ æ”¹å–„å¼€å‘å’Œæµ‹è¯•ä½“éªŒ
- ğŸ¯ ä¸ºæœªæ¥æ‰©å±•å¥ å®šåŸºç¡€

### ä¼˜åŒ–èŒƒå›´

- **é”™è¯¯å¤„ç†**ï¼šç»“æ„åŒ–é”™è¯¯ã€é”™è¯¯ç ã€é”™è¯¯é“¾
- **é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€é…ç½®åŠ è½½ã€éªŒè¯ã€ç¯å¢ƒç®¡ç†
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šå®Œæ•´æ—¥å¿—çº§åˆ«ã€ä¸Šä¸‹æ–‡æ—¥å¿—ã€ç»“æ„åŒ–æ—¥å¿—
- **æ¥å£è®¾è®¡**ï¼šRepository æ‹†åˆ†ã€æ¥å£éš”ç¦»
- **è¿ç»´æ”¯æŒ**ï¼šå¥åº·æ£€æŸ¥ã€ä¼˜é›…å…³é—­ã€ç›‘æ§æŒ‡æ ‡
- **å¼¹æ€§è®¾è®¡**ï¼šé‡è¯•ã€ç†”æ–­ã€é™æµ

---

## ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | æ”¶ç›Š | å®æ–½é¡ºåº | é¢„æœŸå‘¨æœŸ |
|--------|--------|--------|------|----------|----------|
| é”™è¯¯å¤„ç†ä¼˜åŒ– | â­â­â­â­â­ | ä¸­ | é«˜ | 1 | 1å‘¨ |
| é…ç½®ç®¡ç†æ”¹è¿› | â­â­â­â­â­ | å° | é«˜ | 2 | 3å¤© |
| åˆå§‹åŒ–æµç¨‹ä¼˜åŒ– | â­â­â­â­â­ | å° | é«˜ | 3 | 3å¤© |
| æ—¥å¿—ç³»ç»Ÿå¢å¼º | â­â­â­â­ | ä¸­ | ä¸­ | 4 | 5å¤© |
| Repository æ‹†åˆ† | â­â­â­â­ | ä¸­ | ä¸­ | 5 | 5å¤© |
| å¥åº·æ£€æŸ¥ | â­â­â­â­ | å° | ä¸­ | 6 | 2å¤© |
| å“åº”å¤„ç†æ ‡å‡†åŒ– | â­â­â­ | å° | ä¸­ | 7 | 3å¤© |
| æ‹¦æˆªå™¨æŠ½è±¡ | â­â­â­ | ä¸­ | ä½ | 8 | 5å¤© |
| å¼¹æ€§æ¨¡å¼ | â­â­â­ | å¤§ | ä¸­ | 9 | 2å‘¨ |
| å¯è§‚æµ‹æ€§å¢å¼º | â­â­â­ | ä¸­ | ä¸­ | 10 | 1å‘¨ |
| ä¸Šä¸‹æ–‡ä¼ æ’­ | â­â­ | ä¸­ | ä½ | 11 | 5å¤© |
| æµ‹è¯•åŸºç¡€è®¾æ–½ | â­â­ | å¤§ | ä¸­ | 12 | 2å‘¨ |

**å›¾ä¾‹ï¼š**
- ä¼˜å…ˆçº§ï¼šâ­è¶Šå¤šè¶Šé‡è¦
- å·¥ä½œé‡ï¼šå°ï¼ˆ1-3å¤©ï¼‰ã€ä¸­ï¼ˆ3-7å¤©ï¼‰ã€å¤§ï¼ˆ1-2å‘¨ï¼‰
- æ”¶ç›Šï¼šä½ã€ä¸­ã€é«˜

---

## é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

### 1. é”™è¯¯å¤„ç†ä¼˜åŒ– â­â­â­â­â­

#### å½“å‰é—®é¢˜

```go
// internal/domain/error.go
var (
    ErrInvalidParameter = errors.New("å‚æ•°é”™è¯¯")
    ErrNotificationNotFound = errors.New("é€šçŸ¥è®°å½•ä¸å­˜åœ¨")
    // ...
)
```

**å­˜åœ¨çš„é—®é¢˜ï¼š**
- ç¼ºå°‘é”™è¯¯ç ï¼Œéš¾ä»¥å®šä½å’Œåˆ†ç±»
- æ— æ³•æºå¸¦ä¸Šä¸‹æ–‡ä¿¡æ¯
- éš¾ä»¥åŒºåˆ†ä¸šåŠ¡é”™è¯¯ vs ç³»ç»Ÿé”™è¯¯
- æ— æ³•è¿›è¡Œé”™è¯¯é“¾è¿½è¸ª
- ä¸ä¾¿äºç›‘æ§å’Œå‘Šè­¦

#### ä¼˜åŒ–æ–¹æ¡ˆ

##### 1.1 å®šä¹‰ç»“æ„åŒ–é”™è¯¯ç±»å‹

```go
// internal/pkg/errors/error.go
package errors

import "fmt"

// Code é”™è¯¯ç ç±»å‹
type Code string

const (
    // ä¸šåŠ¡é”™è¯¯ç  (Bå¼€å¤´)
    CodeInvalidParameter     Code = "B001" // å‚æ•°é”™è¯¯
    CodeNotificationNotFound Code = "B002" // é€šçŸ¥ä¸å­˜åœ¨
    CodeRateLimited          Code = "B003" // é™æµ
    CodeNoQuota              Code = "B004" // é…é¢ä¸è¶³
    CodeDuplicateKey         Code = "B005" // é‡å¤é”®
    
    // ç³»ç»Ÿé”™è¯¯ç  (Så¼€å¤´)
    CodeDatabaseError        Code = "S001" // æ•°æ®åº“é”™è¯¯
    CodeExternalServiceError Code = "S002" // å¤–éƒ¨æœåŠ¡é”™è¯¯
    CodeRedisError           Code = "S003" // Redisé”™è¯¯
    CodeConfigError          Code = "S004" // é…ç½®é”™è¯¯
    CodeInternalError        Code = "S999" // å†…éƒ¨é”™è¯¯
)

// Error åº”ç”¨é”™è¯¯ç±»å‹
type Error struct {
    Code    Code                   // é”™è¯¯ç 
    Message string                 // é”™è¯¯æ¶ˆæ¯
    Details map[string]interface{} // è¯¦ç»†ä¿¡æ¯
    Cause   error                  // åŸå§‹é”™è¯¯
}

func (e *Error) Error() string {
    if e.Cause != nil {
        return fmt.Sprintf("[%s] %s: %v", e.Code, e.Message, e.Cause)
    }
    return fmt.Sprintf("[%s] %s", e.Code, e.Message)
}

func (e *Error) Unwrap() error {
    return e.Cause
}

// WithCause æ·»åŠ åŸå§‹é”™è¯¯
func (e *Error) WithCause(cause error) *Error {
    e.Cause = cause
    return e
}

// WithDetail æ·»åŠ è¯¦ç»†ä¿¡æ¯
func (e *Error) WithDetail(key string, value interface{}) *Error {
    if e.Details == nil {
        e.Details = make(map[string]interface{})
    }
    e.Details[key] = value
    return e
}

// New åˆ›å»ºæ–°é”™è¯¯
func New(code Code, message string) *Error {
    return &Error{
        Code:    code,
        Message: message,
        Details: make(map[string]interface{}),
    }
}

// IsCode æ£€æŸ¥é”™è¯¯ç 
func IsCode(err error, code Code) bool {
    if e, ok := err.(*Error); ok {
        return e.Code == code
    }
    return false
}
```

##### 1.2 ä½¿ç”¨ç¤ºä¾‹

```go
// service/notification_service.go
func (s *NotificationService) Create(ctx context.Context, req *CreateRequest) error {
    // å‚æ•°éªŒè¯
    if req.BizID == "" {
        return errors.New(errors.CodeInvalidParameter, "ä¸šåŠ¡IDä¸èƒ½ä¸ºç©º").
            WithDetail("field", "biz_id")
    }
    
    // æ•°æ®åº“æ“ä½œ
    if err := s.repo.Create(ctx, notification); err != nil {
        // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤é”®é”™è¯¯
        if isDuplicateKeyError(err) {
            return errors.New(errors.CodeDuplicateKey, "é€šçŸ¥å·²å­˜åœ¨").
                WithDetail("biz_id", req.BizID).
                WithCause(err)
        }
        
        // å…¶ä»–æ•°æ®åº“é”™è¯¯
        return errors.New(errors.CodeDatabaseError, "åˆ›å»ºé€šçŸ¥å¤±è´¥").
            WithDetail("biz_id", req.BizID).
            WithCause(err)
    }
    
    return nil
}

// é”™è¯¯å¤„ç†
func handleError(err error) {
    if errors.IsCode(err, errors.CodeInvalidParameter) {
        // è¿”å› 400
    } else if errors.IsCode(err, errors.CodeDatabaseError) {
        // è¿”å› 500ï¼Œå¹¶å‘Šè­¦
    }
}
```

#### æ”¶ç›Š

âœ… é”™è¯¯å¯è¿½è¸ªã€å¯åˆ†ç±»  
âœ… ä¾¿äºç›‘æ§å’Œå‘Šè­¦  
âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ  
âœ… å¿«é€Ÿå®šä½é—®é¢˜

---

### 2. é…ç½®ç®¡ç†æ”¹è¿› â­â­â­â­â­

#### å½“å‰é—®é¢˜

```go
// é—®é¢˜1ï¼šéƒ¨åˆ†ä»£ç ç›´æ¥ä½¿ç”¨ viper
func InitDB() *gorm.DB {
    dsn := viper.GetString("mysql.dsn")  // ç»•è¿‡ ConfigLoader
}

// é—®é¢˜2ï¼šç¼ºå°‘é…ç½®éªŒè¯
// å¦‚æœé…ç½®é”™è¯¯ï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶å‘ç°

// é—®é¢˜3ï¼šç¯å¢ƒç®¡ç†ä¸ç»Ÿä¸€
// æ²¡æœ‰æ˜ç¡®çš„ç¯å¢ƒåŒºåˆ†æœºåˆ¶
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

##### 2.1 ç»Ÿä¸€é…ç½®åŠ è½½

```go
// æ‰€æœ‰åˆå§‹åŒ–å‡½æ•°æ¥å— ConfigLoader
func InitDB(loader config.ConfigLoader) (*gorm.DB, error) {
    var cfg DatabaseConfig
    if err := loader.Load("mysql", &cfg); err != nil {
        return nil, fmt.Errorf("load mysql config: %w", err)
    }
    
    // ä½¿ç”¨é…ç½®
    db, err := gorm.Open(mysql.Open(cfg.DSN), ...)
    return db, err
}

func InitRedis(loader config.ConfigLoader) (*redis.Client, error) {
    var cfg RedisConfig
    if err := loader.Load("redis", &cfg); err != nil {
        return nil, fmt.Errorf("load redis config: %w", err)
    }
    
    return redis.NewClient(&redis.Options{
        Addr:     cfg.Addr,
        Password: cfg.Password,
        DB:       cfg.DB,
    }), nil
}
```

##### 2.2 é…ç½®éªŒè¯

```go
// internal/pkg/config/validator.go
type Validator interface {
    Validate(loader ConfigLoader) error
}

// æ•°æ®åº“é…ç½®éªŒè¯å™¨
type DatabaseConfigValidator struct{}

func (v *DatabaseConfigValidator) Validate(loader ConfigLoader) error {
    var cfg DatabaseConfig
    if err := loader.Load("mysql", &cfg); err != nil {
        return err
    }
    
    if cfg.DSN == "" {
        return errors.New("mysql.dsn is required")
    }
    
    if cfg.MaxOpenConns <= 0 {
        return errors.New("mysql.max_open_conns must be positive")
    }
    
    return nil
}

// ä½¿ç”¨
func main() {
    loader := config.NewViperConfigLoader()
    
    // éªŒè¯æ‰€æœ‰é…ç½®
    validators := []config.Validator{
        &DatabaseConfigValidator{},
        &RedisConfigValidator{},
        &GrpcConfigValidator{},
    }
    
    for _, v := range validators {
        if err := v.Validate(loader); err != nil {
            log.Fatalf("Config validation failed: %v", err)
        }
    }
    
    // ç»§ç»­åˆå§‹åŒ–...
}
```

##### 2.3 ç¯å¢ƒç®¡ç†

```go
// config/config.yaml
# ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–
mysql:
  dsn: "${MYSQL_DSN:root:root@tcp(localhost:3306)/notification}"
  max_open_conns: "${MYSQL_MAX_CONNS:100}"

redis:
  addr: "${REDIS_ADDR:localhost:6379}"
  password: "${REDIS_PASSWORD:}"

# å¯åŠ¨æ—¶æŒ‡å®šç¯å¢ƒ
# APP_ENV=production go run main.go
```

```go
// åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®
func InitViperConfig() error {
    env := os.Getenv("APP_ENV")
    if env == "" {
        env = "development"
    }
    
    // åŠ è½½åŸºç¡€é…ç½®
    viper.SetConfigFile("config/config.yaml")
    if err := viper.ReadInConfig(); err != nil {
        return err
    }
    
    // åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    envConfigFile := fmt.Sprintf("config/config.%s.yaml", env)
    if _, err := os.Stat(envConfigFile); err == nil {
        viper.SetConfigFile(envConfigFile)
        viper.MergeInConfig()
    }
    
    // ç¯å¢ƒå˜é‡è¦†ç›–
    viper.AutomaticEnv()
    
    return nil
}
```

#### æ”¶ç›Š

âœ… é…ç½®ç®¡ç†ç»Ÿä¸€  
âœ… å¯åŠ¨å‰éªŒè¯é…ç½®  
âœ… æ”¯æŒå¤šç¯å¢ƒ  
âœ… ä¾¿äºæµ‹è¯•

---

### 3. åˆå§‹åŒ–æµç¨‹ä¼˜åŒ– â­â­â­â­â­

#### å½“å‰é—®é¢˜

```go
// é—®é¢˜ï¼šä½¿ç”¨ panic
func InitDB() *gorm.DB {
    db, err := gorm.Open(...)
    if err != nil {
        panic(err)  // éš¾ä»¥æµ‹è¯•ï¼Œä¸ç¬¦åˆ Go ä¹ æƒ¯
    }
    return db
}

// Wire æ— æ³•å¤„ç†é”™è¯¯
func InitGrpcServer() *ioc.App {
    wire.Build(...)
    return &ioc.App{}  // å¦‚æœåˆå§‹åŒ–å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

##### 3.1 è¿”å› error è€Œé panic

```go
// æ‰€æœ‰åˆå§‹åŒ–å‡½æ•°è¿”å› error
func InitDB(loader config.ConfigLoader) (*gorm.DB, error) {
    var cfg DatabaseConfig
    if err := loader.Load("mysql", &cfg); err != nil {
        return nil, fmt.Errorf("load config: %w", err)
    }
    
    db, err := gorm.Open(mysql.Open(cfg.DSN), &gorm.Config{})
    if err != nil {
        return nil, fmt.Errorf("open database: %w", err)
    }
    
    sqlDB, _ := db.DB()
    sqlDB.SetMaxOpenConns(cfg.MaxOpenConns)
    sqlDB.SetMaxIdleConns(cfg.MaxIdleConns)
    
    // æµ‹è¯•è¿æ¥
    if err := sqlDB.Ping(); err != nil {
        return nil, fmt.Errorf("ping database: %w", err)
    }
    
    return db, nil
}

func InitRedis(loader config.ConfigLoader) (*redis.Client, error) {
    var cfg RedisConfig
    if err := loader.Load("redis", &cfg); err != nil {
        return nil, fmt.Errorf("load config: %w", err)
    }
    
    client := redis.NewClient(&redis.Options{
        Addr:     cfg.Addr,
        Password: cfg.Password,
        DB:       cfg.DB,
    })
    
    // æµ‹è¯•è¿æ¥
    if err := client.Ping(context.Background()).Err(); err != nil {
        return nil, fmt.Errorf("ping redis: %w", err)
    }
    
    return client, nil
}
```

##### 3.2 Wire æ”¯æŒ error è¿”å›

```go
// cmd/platform/ioc/wire.go
func InitGrpcServer() (*ioc.App, error) {  // è¿”å› error
    wire.Build(
        BaseSet,
        RegistrySet,
        notificationSvcSet,
        wire.Struct(new(ioc.App), "*"),
    )
    return &ioc.App{}, nil
}

// wire_gen.goï¼ˆç”Ÿæˆçš„ä»£ç ï¼‰
func InitGrpcServer() (*ioc.App, error) {
    configLoader := config.NewViperConfigLoader()
    
    db, err := ioc.InitDB(configLoader)
    if err != nil {
        return nil, err  // Wire è‡ªåŠ¨å¤„ç†é”™è¯¯ä¼ æ’­
    }
    
    redisClient, err := ioc.InitRedis(configLoader)
    if err != nil {
        return nil, err
    }
    
    // ...
    
    app := &ioc.App{
        GrpcServer: server,
        DB:         db,
        Redis:      redisClient,
    }
    return app, nil
}
```

##### 3.3 ç»Ÿä¸€é”™è¯¯å¤„ç†

```go
// cmd/platform/main.go
func main() {
    // åˆå§‹åŒ–é…ç½®
    if err := config.InitViperConfig(); err != nil {
        log.Fatal("Failed to init config", zap.Error(err))
    }
    
    // åˆå§‹åŒ–åº”ç”¨ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
    app, err := ioc.InitGrpcServer()
    if err != nil {
        log.Fatal("Failed to init app", zap.Error(err))
    }
    
    // è¿è¡Œåº”ç”¨
    if err := app.Run(); err != nil {
        log.Fatal("Application error", zap.Error(err))
    }
}
```

#### æ”¶ç›Š

âœ… ç¬¦åˆ Go é”™è¯¯å¤„ç†ä¹ æƒ¯  
âœ… å¯æµ‹è¯•  
âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†  
âœ… Wire è‡ªåŠ¨é”™è¯¯ä¼ æ’­

---

## ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

### 4. æ—¥å¿—ç³»ç»Ÿå¢å¼º â­â­â­â­

#### å½“å‰é—®é¢˜

```go
type LoggerInterface interface {
    Error(msg string, fields ...zap.Field)
    Info(msg string, fields ...zap.Field)
    // ç¼ºå°‘ Debugã€Warn ç­‰çº§åˆ«
    // ç¼ºå°‘ä¸Šä¸‹æ–‡æ—¥å¿—æ”¯æŒ
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```go
// internal/pkg/log/logger.go
package log

import (
    "context"
    "go.uber.org/zap"
)

type Logger interface {
    // å®Œæ•´çš„æ—¥å¿—çº§åˆ«
    Debug(msg string, fields ...Field)
    Info(msg string, fields ...Field)
    Warn(msg string, fields ...Field)
    Error(msg string, fields ...Field)
    
    // ä¸Šä¸‹æ–‡æ—¥å¿—ï¼ˆè‡ªåŠ¨æå– trace_idï¼‰
    DebugCtx(ctx context.Context, msg string, fields ...Field)
    InfoCtx(ctx context.Context, msg string, fields ...Field)
    WarnCtx(ctx context.Context, msg string, fields ...Field)
    ErrorCtx(ctx context.Context, msg string, fields ...Field)
    
    // é“¾å¼è°ƒç”¨
    With(fields ...Field) Logger
}

type Field = zap.Field

// ä½¿ç”¨ç¤ºä¾‹
func (s *NotificationService) Create(ctx context.Context, req *CreateRequest) error {
    logger := log.FromContext(ctx)
    
    logger.InfoCtx(ctx, "å¼€å§‹åˆ›å»ºé€šçŸ¥",
        log.String("biz_id", req.BizID),
        log.String("channel", req.Channel),
    )
    
    // å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—è‡ªåŠ¨åŒ…å« trace_id
    // è¾“å‡º: {"level":"info","trace_id":"xxx","msg":"å¼€å§‹åˆ›å»ºé€šçŸ¥",...}
    
    return nil
}
```

#### æ”¶ç›Š

âœ… å®Œæ•´çš„æ—¥å¿—çº§åˆ«  
âœ… è‡ªåŠ¨è¿½è¸ªé“¾è·¯  
âœ… ç»“æ„åŒ–æ—¥å¿—  
âœ… ä¾¿äºé—®é¢˜å®šä½

---

### 5. Repository æ¥å£æ‹†åˆ† â­â­â­â­

#### å½“å‰é—®é¢˜

```go
// æ¥å£è¿‡å¤§ï¼Œè¿åæ¥å£éš”ç¦»åŸåˆ™
type NotificationRepository interface {
    Create(...)
    CreateWithCallbackLog(...)
    BatchCreate(...)
    GetByID(...)
    BatchGetByIDs(...)
    UpdateStatus(...)
    // ... 15+ ä¸ªæ–¹æ³•
}
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```go
// æŒ‰èŒè´£æ‹†åˆ†
type NotificationReader interface {
    GetByID(ctx context.Context, id int64) (*Notification, error)
    GetByKeys(ctx context.Context, keys []Key) ([]*Notification, error)
    FindReadyNotifications(ctx context.Context, limit int) ([]*Notification, error)
}

type NotificationWriter interface {
    Create(ctx context.Context, n *Notification) error
    BatchCreate(ctx context.Context, ns []*Notification) error
}

type NotificationUpdater interface {
    UpdateStatus(ctx context.Context, id int64, status Status) error
    MarkSuccess(ctx context.Context, id int64) error
    MarkFailed(ctx context.Context, id int64, reason string) error
}

// ç»„åˆä½¿ç”¨
type NotificationRepository interface {
    NotificationReader
    NotificationWriter
    NotificationUpdater
}

// æœåŠ¡æŒ‰éœ€ä¾èµ–
type QueryService struct {
    reader NotificationReader  // åªä¾èµ–è¯»æ¥å£
}

type CreateService struct {
    writer NotificationWriter  // åªä¾èµ–å†™æ¥å£
}
```

#### æ”¶ç›Š

âœ… ç¬¦åˆæ¥å£éš”ç¦»åŸåˆ™  
âœ… æ›´å®¹æ˜“ Mock  
âœ… èŒè´£æ¸…æ™°  
âœ… æŒ‰éœ€ä¾èµ–

---

### 6. å¥åº·æ£€æŸ¥ä¸ä¼˜é›…å…³é—­ â­â­â­â­

#### ä¼˜åŒ–æ–¹æ¡ˆ

```go
// internal/pkg/health/checker.go
type Checker interface {
    Name() string
    Check(ctx context.Context) error
}

type HealthChecker struct {
    checkers map[string]Checker
}

func (h *HealthChecker) Register(checker Checker) {
    h.checkers[checker.Name()] = checker
}

func (h *HealthChecker) CheckAll(ctx context.Context) map[string]error {
    results := make(map[string]error)
    for name, checker := range h.checkers {
        results[name] = checker.Check(ctx)
    }
    return results
}

// æ•°æ®åº“å¥åº·æ£€æŸ¥
type DatabaseChecker struct {
    db *gorm.DB
}

func (c *DatabaseChecker) Name() string { return "database" }

func (c *DatabaseChecker) Check(ctx context.Context) error {
    sqlDB, _ := c.db.DB()
    return sqlDB.PingContext(ctx)
}

// HTTP ç«¯ç‚¹
func healthHandler(checker *health.HealthChecker) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        results := checker.CheckAll(r.Context())
        
        allHealthy := true
        for _, err := range results {
            if err != nil {
                allHealthy = false
                break
            }
        }
        
        if allHealthy {
            w.WriteHeader(http.StatusOK)
        } else {
            w.WriteHeader(http.StatusServiceUnavailable)
        }
        
        json.NewEncoder(w).Encode(results)
    }
}
```

#### æ”¶ç›Š

âœ… Kubernetes å‹å¥½  
âœ… é›¶åœæœºéƒ¨ç½²  
âœ… å¿«é€Ÿæ•…éšœæ£€æµ‹

---

### 7. å“åº”å¤„ç†æ ‡å‡†åŒ– â­â­â­

#### ä¼˜åŒ–æ–¹æ¡ˆ

```go
// internal/pkg/response/response.go
type Response struct {
    Code    string      `json:"code"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
    TraceID string      `json:"trace_id,omitempty"`
}

func Success(data interface{}) *Response {
    return &Response{
        Code:    "SUCCESS",
        Message: "æ“ä½œæˆåŠŸ",
        Data:    data,
    }
}

func Error(err error) *Response {
    if e, ok := err.(*errors.Error); ok {
        return &Response{
            Code:    string(e.Code),
            Message: e.Message,
        }
    }
    
    return &Response{
        Code:    "INTERNAL_ERROR",
        Message: "å†…éƒ¨é”™è¯¯",
    }
}

// gRPC é”™è¯¯è½¬æ¢æ‹¦æˆªå™¨
func ErrorInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx, req, info, handler) (interface{}, error) {
        resp, err := handler(ctx, req)
        if err != nil {
            return nil, ErrorToGRPCStatus(err)
        }
        return resp, nil
    }
}
```

---

### 8. æ‹¦æˆªå™¨æŠ½è±¡ â­â­â­

#### ä¼˜åŒ–æ–¹æ¡ˆ

```go
// é…ç½®åŒ–æ‹¦æˆªå™¨
// config.yaml
interceptors:
  metrics:
    enabled: true
    priority: 10
  logging:
    enabled: true
    priority: 20
  tracing:
    enabled: true
    priority: 30

// ä»£ç 
type InterceptorConfig struct {
    Name     string
    Enabled  bool
    Priority int
}

func LoadInterceptors(loader config.ConfigLoader) []grpc.UnaryServerInterceptor {
    var configs []InterceptorConfig
    loader.Load("interceptors", &configs)
    
    // æŒ‰ä¼˜å…ˆçº§æ’åºå¹¶æ„å»º
    sort.Slice(configs, func(i, j int) bool {
        return configs[i].Priority < configs[j].Priority
    })
    
    var interceptors []grpc.UnaryServerInterceptor
    for _, cfg := range configs {
        if !cfg.Enabled {
            continue
        }
        interceptors = append(interceptors, buildInterceptor(cfg.Name))
    }
    
    return interceptors
}
```

---

## ä½ä¼˜å…ˆçº§ä¼˜åŒ–

### 9. å¼¹æ€§æ¨¡å¼æŠ½è±¡ â­â­â­

```go
// é‡è¯•å™¨
retryer := resilience.NewRetryer(&ExponentialBackoffPolicy{
    MaxAttempts:  3,
    InitialDelay: 100 * time.Millisecond,
})

err := retryer.Do(ctx, func() error {
    return callExternalService()
})

// ç†”æ–­å™¨
cb := resilience.NewCircuitBreaker(5, 30*time.Second)
err := cb.Call(ctx, func() error {
    return callExternalService()
})

// é™æµå™¨
limiter := rate.NewLimiter(100, 10) // 100 QPS, burst 10
limiter.Wait(ctx)
```

### 10. å¯è§‚æµ‹æ€§å¢å¼º â­â­â­

```go
// Prometheus Metrics
var (
    notificationTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "notification_total",
            Help: "Total notifications",
        },
        []string{"channel", "status"},
    )
    
    notificationDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "notification_duration_seconds",
            Help: "Notification duration",
        },
        []string{"channel"},
    )
)

// ä½¿ç”¨
notificationTotal.WithLabelValues("sms", "success").Inc()
notificationDuration.WithLabelValues("sms").Observe(duration.Seconds())

// æš´éœ² metrics
http.Handle("/metrics", promhttp.Handler())
```

---

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ï¼šåŸºç¡€ä¼˜åŒ–

**Week 1:**
- âœ… å®ç°ç»“æ„åŒ–é”™è¯¯ç±»å‹
- âœ… å®Œå–„ ConfigLoader æ¥å£
- âœ… é…ç½®éªŒè¯æœºåˆ¶

**Week 2:**
- âœ… æ”¹é€ æ‰€æœ‰åˆå§‹åŒ–å‡½æ•°ï¼ˆè¿”å› errorï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… æ›´æ–° Wire é…ç½®

**äº¤ä»˜ç‰©ï¼š**
- ç»“æ„åŒ–é”™è¯¯ç³»ç»Ÿ
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†
- ä¼˜é›…çš„åˆå§‹åŒ–æµç¨‹

### ç¬¬äºŒé˜¶æ®µï¼ˆ2-3å‘¨ï¼‰ï¼šæ¥å£ä¼˜åŒ–

**Week 3:**
- âœ… å¢å¼ºæ—¥å¿—æ¥å£
- âœ… ä¸Šä¸‹æ–‡æ—¥å¿—æ”¯æŒ

**Week 4-5:**
- âœ… æ‹†åˆ† Repository æ¥å£
- âœ… æ ‡å‡†åŒ–å“åº”å¤„ç†

**äº¤ä»˜ç‰©ï¼š**
- å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ
- æ¸…æ™°çš„ Repository æ¥å£
- æ ‡å‡†åŒ–çš„å“åº”å¤„ç†

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4å‘¨ï¼‰ï¼šå¢å¼ºç‰¹æ€§

**Week 6:**
- âœ… å®ç°å¥åº·æ£€æŸ¥
- âœ… å®Œå–„ä¼˜é›…å…³é—­

**Week 7:**
- âœ… æ‹¦æˆªå™¨æŠ½è±¡
- âœ… å¯é…ç½®ä¸­é—´ä»¶é“¾

**äº¤ä»˜ç‰©ï¼š**
- å¥åº·æ£€æŸ¥ç«¯ç‚¹
- å¯é…ç½®çš„æ‹¦æˆªå™¨ç³»ç»Ÿ

### ç¬¬å››é˜¶æ®µï¼ˆ4-6å‘¨ï¼‰ï¼šé«˜çº§ç‰¹æ€§

**Week 8-9:**
- âœ… é‡è¯•å™¨ã€ç†”æ–­å™¨
- âœ… å¼¹æ€§æ¨¡å¼æŠ½è±¡

**Week 10-12:**
- âœ… Metrics æ ‡å‡†åŒ–
- âœ… åˆ†å¸ƒå¼è¿½è¸ª
- âœ… æ€§èƒ½ä¼˜åŒ–

**äº¤ä»˜ç‰©ï¼š**
- å¼¹æ€§æ¨¡å¼åº“
- å®Œæ•´çš„å¯è§‚æµ‹æ€§ç³»ç»Ÿ

---

## é¢„æœŸæ”¶ç›Š

### æ•´ä½“æå‡

| ç»´åº¦ | å½“